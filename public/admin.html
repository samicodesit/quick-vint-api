<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoLister AI - Admin Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4f46e5;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            background: #f8fafc;
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .auth-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Logs specific styles */
        .logs-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .logs-filters input, .logs-filters select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .logs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .logs-table th,
        .logs-table td {
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        
        .logs-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .logs-table tr.suspicious {
            background-color: #fef2f2;
        }
        
        .logs-table tr.error {
            background-color: #fffbeb;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .suspicious-badge {
            background-color: #dc2626;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button.active {
            background: #4f46e5;
            color: white;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .prompt-cell {
            max-width: 300px;
            word-break: break-word;
            font-family: monospace;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-flag {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .btn-unflag {
            background: #16a34a;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .tables-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .tables-row {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 15px 0;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .big-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4f46e5;
            margin: 10px 0;
        }
        
        .growth-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .growth-item {
            text-align: center;
            padding: 15px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #f9fafb;
        }
        
        .growth-number {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 5px;
        }
        
        .growth-label {
            display: block;
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .data-table th {
            background-color: #f9fafb;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            font-size: 0.85rem;
            color: #374151;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .email-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calls-cell {
            text-align: center;
            font-weight: bold;
            color: #4f46e5;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tier-free { 
            background: #fee2e2; 
            color: #991b1b; 
        }
        
        .tier-unlimited { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .tier-unlimitedmonthly { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .tier-starter { 
            background: #dcfce7; 
            color: #166534; 
        }
        
        .tier-pro { 
            background: #fef3c7; 
            color: #92400e; 
        }
        
        .tier-business { 
            background: #e0e7ff; 
            color: #3730a3; 
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-active { 
            background: #dcfce7; 
            color: #166534; 
        }
        
        .status-free { 
            background: #f3f4f6; 
            color: #374151; 
        }
        
        .refresh-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            color: #6b7280;
            padding: 20px;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        input[type="password"] {
            width: 300px;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 0.95rem;
        }
        
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        button:hover {
            background: #4338ca;
        }
        
        .timestamp {
            color: #6b7280;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 20px;
        }
        
        .success-indicator {
            color: #10b981;
            background: #ecfdf5;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #a7f3d0;
        }

        /* Enhanced Log Inspector Styles */
        .btn-inspect {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 4px;
            transition: background 0.2s;
        }

        .btn-inspect:hover {
            background: #2563eb;
        }

        .image-count-badge {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .user-info strong {
            color: #111827;
        }

        .prompt-preview, .title-preview {
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .safe-badge {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .modal-header h2 {
            margin: 0;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }

        /* Inspector Content Styles */
        .inspector-section {
            margin-bottom: 25px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .inspector-header {
            background: #f9fafb;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inspector-header:hover {
            background: #f3f4f6;
        }

        .inspector-content {
            padding: 16px;
        }

        .inspector-content.collapsed {
            display: none;
        }

        .inspector-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 8px 16px;
            align-items: start;
        }

        .inspector-label {
            font-weight: 500;
            color: #6b7280;
            padding: 4px 0;
        }

        .inspector-value {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: #f9fafb;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .image-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: #f9fafb;
        }

        .image-container img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-container img:hover {
            transform: scale(1.02);
        }

        .image-info {
            padding: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .json-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .expand-btn {
            color: #6b7280;
            font-weight: normal;
            font-size: 14px;
        }

        .flag-reason {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 12px;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è AutoLister AI Admin Dashboard</h1>
        
        <div id="authSection" class="auth-section">
            <h3>üîê Admin Authentication</h3>
            <div style="margin-bottom: 15px;">
                <input type="password" id="adminSecret" placeholder="Enter admin secret">
                <button onclick="authenticate()">Access Dashboard</button>
            </div>
            <div style="margin-top: 10px;">
                <label style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; color: #6b7280;">
                    <input type="checkbox" id="rememberDevice" style="margin: 0;">
                    Remember this device (stores key securely in browser)
                </label>
            </div>
            <div id="authError" class="error-message hidden" style="margin-top: 10px;"></div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Admin Dashboard</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="refresh-btn" onclick="refreshCurrentTab()">üîÑ Refresh Data</button>
                    <button onclick="logout()" class="btn-secondary">Logout</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-button" onclick="switchTab('logs')">üîç API Logs</button>
            </div>
            
            <!-- Overview Tab Content -->
            <div id="overviewTab" class="tab-content active">
                <div id="errorMessage" class="error-message hidden"></div>
                <div id="loadingMessage" class="loading hidden">Loading stats...</div>
            
            <!-- Row 1: Key Metrics -->
            <div class="stats-row">
                <div class="stat-card">
                    <h3>üìä Today's Usage</h3>
                    <div class="big-number" id="todayRequests">-</div>
                    <div>Total API Requests</div>
                    <div style="margin-top: 10px;">
                        <strong>Estimated Cost:</strong> $<span id="todayCost">0.00</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>üë• User Growth</h3>
                    <div class="growth-stats">
                        <div class="growth-item">
                            <span class="growth-number" id="totalUsers">-</span>
                            <span class="growth-label">Total Users</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="newToday">-</span>
                            <span class="growth-label">New Today</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="newThisWeek">-</span>
                            <span class="growth-label">This Week</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="activePaid">-</span>
                            <span class="growth-label">Paid Users</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>üí∞ Revenue Overview</h3>
                    <div class="growth-stats">
                        <div class="growth-item">
                            <span class="growth-number" id="monthlyRevenue">-</span>
                            <span class="growth-label">Monthly Revenue</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="conversionRate">-</span>
                            <span class="growth-label">Conversion Rate</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Usage Tables -->
            <div class="tables-row">
                <div class="stat-card">
                    <h3>Today's Daily Usage</h3>
                    <div id="todaysUsageContent">
                        <table id="recentSignupsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Signup Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>üèÜ Top Users (All Time)</h3>
                    <div id="topUsersContent">
                        <table id="topUsersTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>API Calls (This Month)</th>
                                    <th>Tier</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Row 3: Rate Limits -->
            <div class="stat-card">
                <h3>Rate Limited Users (Last Hour)</h3>
                <div id="rateLimitsContent">Loading...</div>
            </div>

            <div class="timestamp" id="lastUpdated"></div>
            </div> <!-- End Overview Tab -->
            
            <!-- API Logs Tab Content -->
            <div id="logsTab" class="tab-content">
                <!-- Summary Cards -->
                <div class="stats-row">
                    <div class="stat-card">
                        <h3>Total Requests</h3>
                        <div class="big-number" id="totalRequests">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Suspicious Activity</h3>
                        <div class="big-number" id="suspiciousRequests" style="color: #dc2626;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Error Requests</h3>
                        <div class="big-number" id="errorRequests" style="color: #d97706;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Requests</h3>
                        <div class="big-number" id="todayRequests">-</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="stat-card" style="margin-bottom: 20px;">
                    <div class="logs-filters">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="suspiciousOnly">
                            Suspicious Only
                        </label>
                        
                        <input type="text" id="userIdFilter" placeholder="User ID" style="width: 200px;">
                        
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        
                        <button onclick="loadLogs()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîç Filter</button>
                        <button onclick="clearLogFilters()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Clear</button>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="stat-card">
                    <div id="logsLoading" class="loading hidden">Loading logs...</div>
                    <div id="logsError" class="error-message hidden"></div>
                    
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Prompt</th>
                                    <th>Generated</th>
                                    <th>Flags</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="logsPagination" style="margin-top: 20px;">
                    </div>
                </div>
            </div> <!-- End Logs Tab -->
            
            <!-- Log Inspector Modal -->
            <div id="logInspectorModal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üîç Request Inspector</h2>
                        <button class="modal-close" onclick="closeLogInspector()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="inspectorContent">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
            
        </div> <!-- End Dashboard Section -->
    </div>

    <script>
        let adminSecret = '';
        let currentLogsPage = 1;

        // Helper functions must be defined before they're used in template strings
        function truncate(text, maxLength) {
            if (!text) return 'N/A';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Helper function to get image count with fallback to full_request_body
        function getImageCount(log) {
            // First try the image_urls column (check for non-null, non-empty string)
            if (log.image_urls && typeof log.image_urls === 'string' && log.image_urls.trim() !== '') {
                try {
                    return JSON.parse(log.image_urls).length;
                } catch (e) {
                    console.warn('Failed to parse image_urls:', e);
                }
            }
            
            // Fallback: parse from full_request_body
            if (log.full_request_body) {
                try {
                    const requestBody = typeof log.full_request_body === 'string' 
                        ? JSON.parse(log.full_request_body) 
                        : log.full_request_body;
                    if (requestBody.imageUrls && Array.isArray(requestBody.imageUrls)) {
                        return requestBody.imageUrls.length;
                    }
                } catch (e) {
                    console.warn('Failed to parse full_request_body:', e);
                }
            }
            
            return 0;
        }

        // Helper function to get image URLs with fallback
        function getImageUrls(log) {
            // First try the image_urls column (check for non-null, non-empty string)
            if (log.image_urls && typeof log.image_urls === 'string' && log.image_urls.trim() !== '') {
                try {
                    return JSON.parse(log.image_urls);
                } catch (e) {
                    console.warn('Failed to parse image_urls:', e);
                }
            }
            
            // Fallback: parse from full_request_body
            if (log.full_request_body) {
                try {
                    const requestBody = typeof log.full_request_body === 'string' 
                        ? JSON.parse(log.full_request_body) 
                        : log.full_request_body;
                    if (requestBody.imageUrls && Array.isArray(requestBody.imageUrls)) {
                        return requestBody.imageUrls;
                    }
                } catch (e) {
                    console.warn('Failed to parse full_request_body:', e);
                }
            }
            
            return [];
        }

        // Tab Management
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Mark button as active
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'overview') {
                loadStats();
            } else if (tabName === 'logs') {
                loadLogs();
            }
        }

        function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab-button.active').textContent;
            if (activeTab.includes('Overview')) {
                loadStats();
            } else if (activeTab.includes('Logs')) {
                loadLogs();
            }
        }

        // API Logs Functions
        async function loadLogs(page = 1) {
            if (!adminSecret) return;

            const loading = document.getElementById('logsLoading');
            const error = document.getElementById('logsError');
            const tbody = document.getElementById('logsTableBody');
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            currentLogsPage = page;

            try {
                // Build query parameters
                const params = new URLSearchParams({
                    action: 'view-logs',
                    page: page.toString(),
                    limit: '50'
                });

                if (document.getElementById('suspiciousOnly').checked) {
                    params.append('suspicious', 'true');
                }

                const userId = document.getElementById('userIdFilter').value;
                if (userId) {
                    params.append('user_id', userId);
                }

                const startDate = document.getElementById('startDate').value;
                if (startDate) {
                    params.append('start_date', startDate);
                }

                const endDate = document.getElementById('endDate').value;
                if (endDate) {
                    params.append('end_date', endDate);
                }

                const response = await fetch(`/api/admin/logs?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load logs');
                }

                const data = await response.json();
                
                // Update summary
                updateLogsSummary(data.summary);
                
                // Update table
                updateLogsTable(data.logs);
                
                // Update pagination
                updateLogsPagination(data.pagination);
                
            } catch (err) {
                error.textContent = 'Failed to load logs: ' + err.message;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function updateLogsSummary(summary) {
            document.getElementById('totalRequests').textContent = summary?.total_requests || 0;
            document.getElementById('suspiciousRequests').textContent = summary?.suspicious_requests || 0;
            document.getElementById('errorRequests').textContent = summary?.error_requests || 0;
            document.getElementById('todayRequests').textContent = summary?.today_requests || 0;
        }

        function updateLogsTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';

            logs.forEach(log => {
                const row = tbody.insertRow();
                row.className = 'log-row';
                row.dataset.logId = log.id;
                
                // Apply row styling
                if (log.suspicious_activity) {
                    row.classList.add('suspicious');
                } else if (log.response_status >= 400) {
                    row.classList.add('error');
                }

                row.innerHTML = `
                    <td style="font-size: 12px; min-width: 120px;">${formatDate(log.created_at)}</td>
                    <td style="font-size: 11px; min-width: 140px;">
                        <div class="user-info">
                            <strong>${log.user_email || 'N/A'}</strong><br>
                            <span style="color: #6b7280; font-family: monospace;">${log.user_id?.substring(0, 12)}...</span>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <span class="status-badge ${log.response_status >= 200 && log.response_status < 300 ? 'status-success' : 'status-error'}">
                            ${log.response_status}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="image-count-badge">${getImageCount(log)}</span>
                    </td>
                    <td class="prompt-cell" style="max-width: 200px;">
                        <div class="prompt-preview">${truncate(log.raw_prompt, 100)}</div>
                    </td>
                    <td style="max-width: 150px;">
                        <div class="title-preview">${truncate(log.generated_title, 60)}</div>
                    </td>
                    <td style="text-align: center; min-width: 100px;">
                        ${log.suspicious_activity ? 
                            '<span class="suspicious-badge">üö® FLAGGED</span>' : 
                            '<span class="safe-badge">‚úÖ OK</span>'
                        }
                        ${log.flagged_reason ? `<br><small style="color: #ef4444;">${truncate(log.flagged_reason, 25)}</small>` : ''}
                    </td>
                    <td style="min-width: 140px;">
                        <div class="action-buttons">
                            <button class="btn-inspect" onclick="openLogInspector('${log.id}', ${JSON.stringify(log).replace(/"/g, '&quot;')})">
                                üîç Inspect
                            </button>
                            ${!log.suspicious_activity ? 
                                `<button class="btn-flag" onclick="flagLog('${log.id}', 'manual_review')">Flag</button>` :
                                `<button class="btn-unflag" onclick="unflagLog('${log.id}', 'reviewed_safe')">Unflag</button>`
                            }
                        </div>
                    </td>
                `;
            });
        }

        function updateLogsPagination(pagination) {
            const container = document.getElementById('logsPagination');
            container.innerHTML = '';

            if (pagination.total_pages <= 1) return;

            // Previous button
            if (pagination.page > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.onclick = () => loadLogs(pagination.page - 1);
                prevBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;';
                container.appendChild(prevBtn);
            }

            // Page numbers (show current and nearby)
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadLogs(i);
                if (i === pagination.page) {
                    pageBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: #4f46e5; color: white; border: 1px solid #4f46e5; border-radius: 4px; cursor: pointer;';
                } else {
                    pageBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;';
                }
                container.appendChild(pageBtn);
            }

            // Next button
            if (pagination.page < pagination.total_pages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = () => loadLogs(pagination.page + 1);
                nextBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;';
                container.appendChild(nextBtn);
            }
        }

        async function flagLog(logId, reason) {
            try {
                const response = await fetch('/api/admin/logs?action=flag-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminSecret}`
                    },
                    body: JSON.stringify({
                        logId,
                        reason,
                        action: 'flag'
                    })
                });

                if (response.ok) {
                    loadLogs(currentLogsPage); // Refresh current page
                } else {
                    alert('Failed to flag log');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function unflagLog(logId, reason) {
            try {
                const response = await fetch('/api/admin/logs?action=flag-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminSecret}`
                    },
                    body: JSON.stringify({
                        logId,
                        reason,
                        action: 'unflag'
                    })
                });

                if (response.ok) {
                    loadLogs(currentLogsPage); // Refresh current page
                } else {
                    alert('Failed to unflag log');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function clearLogFilters() {
            document.getElementById('suspiciousOnly').checked = false;
            document.getElementById('userIdFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            currentLogsPage = 1;
            loadLogs();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Log Inspector Functions
        function openLogInspector(logId, logData) {
            const modal = document.getElementById('logInspectorModal');
            const content = document.getElementById('inspectorContent');
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Build inspector content
            content.innerHTML = generateInspectorContent(logData);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeLogInspector() {
            const modal = document.getElementById('logInspectorModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function generateInspectorContent(log) {
            const imageUrls = getImageUrls(log);
            const requestMetadata = log.request_metadata ? JSON.parse(log.request_metadata) : {};
            const responseData = log.response_data ? JSON.parse(log.response_data) : {};
            
            return `
                <!-- Basic Info Section -->
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>üìã Basic Information</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content">
                        <div class="inspector-grid">
                            <div class="inspector-label">Request ID:</div>
                            <div class="inspector-value">${log.id}</div>
                            
                            <div class="inspector-label">Timestamp:</div>
                            <div class="inspector-value">${formatDate(log.created_at)}</div>
                            
                            <div class="inspector-label">User Email:</div>
                            <div class="inspector-value">${log.user_email || 'N/A'}</div>
                            
                            <div class="inspector-label">User ID:</div>
                            <div class="inspector-value">${log.user_id || 'N/A'}</div>
                            
                            <div class="inspector-label">Response Status:</div>
                            <div class="inspector-value">
                                <span class="status-badge ${log.response_status >= 200 && log.response_status < 300 ? 'status-success' : 'status-error'}">
                                    ${log.response_status}
                                </span>
                            </div>
                            
                            <div class="inspector-label">Response Time:</div>
                            <div class="inspector-value">${log.response_time_ms ? log.response_time_ms + 'ms' : 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <!-- Images Section -->
                ${imageUrls.length > 0 ? `
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>üñºÔ∏è Images (${imageUrls.length})</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content">
                        <div class="images-grid">
                            ${imageUrls.map((url, index) => `
                                <div class="image-container">
                                    <img src="${url}" alt="Product Image ${index + 1}" onclick="openImageModal('${url}')" loading="lazy">
                                    <div class="image-info">
                                        Image ${index + 1}
                                        <br><small>${url.length > 50 ? '...' + url.slice(-50) : url}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Prompt Section -->
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>üí¨ User Prompt</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content">
                        <div class="inspector-value">${log.raw_prompt || 'N/A'}</div>
                    </div>
                </div>

                <!-- AI Response Section -->
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>ü§ñ AI Generated Content</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content">
                        <div class="inspector-grid">
                            <div class="inspector-label">Generated Title:</div>
                            <div class="inspector-value">${log.generated_title || 'N/A'}</div>
                            
                            <div class="inspector-label">Generated Description:</div>
                            <div class="inspector-value">${log.generated_description || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <!-- Request Metadata Section -->
                ${Object.keys(requestMetadata).length > 0 ? `
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>üîß Request Metadata</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content collapsed">
                        <div class="json-container">${JSON.stringify(requestMetadata, null, 2)}</div>
                    </div>
                </div>
                ` : ''}

                <!-- Response Data Section -->
                ${Object.keys(responseData).length > 0 ? `
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>üì§ Response Data</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content collapsed">
                        <div class="json-container">${JSON.stringify(responseData, null, 2)}</div>
                    </div>
                </div>
                ` : ''}

                <!-- Suspicious Activity Section -->
                ${log.suspicious_activity ? `
                <div class="inspector-section">
                    <div class="inspector-header" onclick="toggleSection(this)">
                        <span>üö® Suspicious Activity</span>
                        <span class="expand-btn">‚ñº</span>
                    </div>
                    <div class="inspector-content">
                        <div class="flag-reason">
                            <strong>Flagged Reason:</strong> ${log.flagged_reason || 'Automatically detected'}
                            <br><strong>Reviewed At:</strong> ${log.reviewed_at ? formatDate(log.reviewed_at) : 'Not reviewed'}
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        function toggleSection(header) {
            const content = header.nextElementSibling;
            const expandBtn = header.querySelector('.expand-btn');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                expandBtn.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                expandBtn.textContent = '‚ñ∂';
            }
        }

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">
                    <div style="position: relative; max-width: 90%; max-height: 90%;">
                        <img src="${imageUrl}" style="max-width: 100%; max-height: 100%; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);">
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); document.body.style.overflow = ''" 
                                style="position: absolute; top: -10px; right: -10px; background: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">&times;</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    document.body.style.overflow = '';
                }
            };
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'logInspectorModal') {
                closeLogInspector();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLogInspector();
            }
        });

        // Security: Simple encryption for localStorage (basic obfuscation)
        function encryptKey(key) {
            return btoa(key.split('').reverse().join(''));
        }

        function decryptKey(encrypted) {
            try {
                return atob(encrypted).split('').reverse().join('');
            } catch (e) {
                return null;
            }
        }

        // Check for remembered key on page load
        function checkRememberedAuth() {
            const rememberedKey = localStorage.getItem('admin_auth_key');
            if (rememberedKey) {
                const decrypted = decryptKey(rememberedKey);
                if (decrypted) {
                    console.log('Found remembered auth key, attempting auto-login...');
                    adminSecret = decrypted;
                    document.getElementById('adminSecret').value = decrypted;
                    document.getElementById('rememberDevice').checked = true;
                    
                    // Try to authenticate with remembered key
                    testAuthAndLogin();
                }
            }
        }

        // Test authentication without showing UI changes
        async function testAuthAndLogin() {
            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (response.ok) {
                    // Success - show dashboard
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadStats();
                } else {
                    // Failed - clear remembered key and show auth form
                    localStorage.removeItem('admin_auth_key');
                    showAuthError('Stored authentication expired. Please re-enter your admin key.');
                }
            } catch (error) {
                // Network error - show auth form but keep remembered key
                console.log('Network error during auto-auth, showing login form');
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideAuthError() {
            document.getElementById('authError').classList.add('hidden');
        }

        function authenticate() {
            const inputSecret = document.getElementById('adminSecret').value.trim();
            const rememberDevice = document.getElementById('rememberDevice').checked;
            
            if (!inputSecret) {
                showAuthError('Please enter admin secret');
                return;
            }

            hideAuthError();
            adminSecret = inputSecret;
            
            // Test the key by making an API call
            testAuthentication(rememberDevice);
        }

        async function testAuthentication(shouldRemember) {
            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (response.ok) {
                    // Success - save key if requested
                    if (shouldRemember) {
                        const encrypted = encryptKey(adminSecret);
                        localStorage.setItem('admin_auth_key', encrypted);
                        console.log('Admin key saved for future sessions');
                    } else {
                        // Clear any previously saved key if user unchecked remember
                        localStorage.removeItem('admin_auth_key');
                    }
                    
                    // Show dashboard
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadStats();
                } else {
                    showAuthError('Invalid admin secret. Please try again.');
                }
            } catch (error) {
                showAuthError('Network error. Please check your connection and try again.');
            }
        }

        // Add logout functionality
        function logout() {
            // Clear session
            adminSecret = '';
            
            // Clear remembered key
            localStorage.removeItem('admin_auth_key');
            
            // Reset form
            document.getElementById('adminSecret').value = '';
            document.getElementById('rememberDevice').checked = false;
            hideAuthError();
            
            // Show auth section
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }

        async function loadStats() {
            const errorDiv = document.getElementById('errorMessage');
            const loadingDiv = document.getElementById('loadingMessage');
            
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayStats(data);
                
            } catch (error) {
                console.error('Error loading stats:', error);
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        function displayStats(data) {
            // Filter out demo account
            const filteredUsers = data.topUsers.filter(user => user.email !== 'samicodesit@gmail.com');
            
            // Create user lookup map for rate limiting section
            const userLookup = {};
            data.topUsers.forEach(user => {
                userLookup[user.id] = user.email;
            });
            
            // Today's stats
            document.getElementById('todayRequests').textContent = data.today.totalRequests;
            document.getElementById('todayCost').textContent = data.today.estimatedCost.toFixed(2);

            // User growth stats (excluding demo account)
            const totalUsers = filteredUsers.length;
            const paidUsers = filteredUsers.filter(u => u.subscription_status === 'active').length;
            const conversionRate = totalUsers > 0 ? ((paidUsers / totalUsers) * 100).toFixed(1) + '%' : '0%';
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activePaid').textContent = paidUsers;
            document.getElementById('conversionRate').textContent = conversionRate;
            
            // Calculate estimated monthly revenue
            const monthlyRevenue = paidUsers * 3.99;
            document.getElementById('monthlyRevenue').textContent = '‚Ç¨' + monthlyRevenue.toFixed(0);

            // Sort users by creation date for recent signups (most recent first)
            const sortedUsersByDate = [...filteredUsers].sort((a, b) => {
                const dateA = new Date(a.created_at || '2020-01-01');
                const dateB = new Date(b.created_at || '2020-01-01');
                return dateB - dateA; // Most recent first
            });
            
            // Calculate new users today and this week with proper timezone handling
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            let newToday = 0;
            let newThisWeek = 0;
            
            sortedUsersByDate.forEach(user => {
                if (!user.created_at) return;
                
                const userDate = new Date(user.created_at);
                const userDateOnly = new Date(userDate.getFullYear(), userDate.getMonth(), userDate.getDate());
                
                if (userDateOnly.getTime() === today.getTime()) {
                    newToday++;
                }
                if (userDateOnly >= weekAgo) {
                    newThisWeek++;
                }
            });
            
            document.getElementById('newToday').textContent = newToday;
            document.getElementById('newThisWeek').textContent = newThisWeek;

            // Top users table by API calls (exclude demo account)
            const topUsersByUsage = [...filteredUsers].sort((a, b) => b.api_calls_this_month - a.api_calls_this_month);
            const tbody = document.querySelector('#topUsersTable tbody');
            tbody.innerHTML = '';
            
            topUsersByUsage.slice(0, 10).forEach(user => {
                const row = tbody.insertRow();
                const tierClass = user.subscription_tier.replace(/_/g, '').toLowerCase();
                row.innerHTML = `
                    <td class="email-cell" title="${user.email}">${user.email}</td>
                    <td class="calls-cell">${user.api_calls_this_month}</td>
                    <td><span class="tier-badge tier-${tierClass}">${user.subscription_tier.replace('_', ' ')}</span></td>
                `;
            });

            // Recent signups table (sorted by creation date, most recent first)
            const signupsBody = document.querySelector('#recentSignupsTable tbody');
            signupsBody.innerHTML = '';
            
            sortedUsersByDate.slice(0, 15).forEach(user => { // Show more recent signups
                const row = signupsBody.insertRow();
                
                let dateStr = 'Unknown';
                if (user.created_at) {
                    const userDate = new Date(user.created_at);
                    const now = new Date();
                    const diffMs = now - userDate;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        dateStr = 'Today';
                    } else if (diffDays === 1) {
                        dateStr = 'Yesterday';
                    } else if (diffDays < 7) {
                        dateStr = `${diffDays}d ago`;
                    } else {
                        dateStr = userDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                }
                
                const statusClass = user.subscription_status === 'active' ? 'status-active' : 'status-free';
                const statusText = user.subscription_status === 'active' ? 'Paid' : 'Free';
                
                row.innerHTML = `
                    <td class="email-cell" title="${user.email}">${user.email}</td>
                    <td style="text-align: center;">${dateStr}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
            });

            // Rate limits
            const rateLimitsDiv = document.getElementById('rateLimitsContent');
            if (data.activeRateLimits.length === 0) {
                rateLimitsDiv.innerHTML = '<div class="success-indicator">‚úÖ No daily usage recorded yet today</div>';
            } else {
                let html = '<table class="data-table"><thead><tr><th>User</th><th>Tier</th><th>Usage</th><th>Status</th><th>Expires</th></tr></thead><tbody>';
                data.activeRateLimits.forEach(limit => {
                    const expiry = new Date(limit.expires_at).toLocaleString();
                    const userEmail = limit.email || 'Unknown';
                    const userIdShort = limit.user_id.substring(0, 8) + '...';
                    const statusHtml = limit.is_blocked 
                        ? `<span style="color: #dc2626; font-weight: 600;">Blocked</span>`
                        : `<span style="color: #059669;">OK</span>`;
                    
                    html += `<tr>
                        <td>
                            <div style="font-weight: 500;">${userEmail}</div>
                            <div style="font-size: 0.75rem; color: #6b7280; font-family: monospace;">${userIdShort}</div>
                        </td>
                        <td><span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.875rem; text-transform: capitalize;">${limit.tier}</span></td>
                        <td><strong>${limit.count}</strong> / ${limit.daily_limit}</td>
                        <td>${statusHtml}</td>
                        <td>${expiry}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                rateLimitsDiv.innerHTML = html;
            }

            // Timestamp
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
        }

                // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkRememberedAuth();
        });

        // Auto-refresh every 30 seconds if dashboard is visible
        setInterval(() => {
            if (!document.getElementById('dashboardSection').classList.contains('hidden')) {
                loadStats();
            }
        }, 5 * 60 * 1000);

        // Allow Enter key to authenticate
        document.getElementById('adminSecret').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticate();
            }
        });
    </script>
</body>
</html>