<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoLister AI - Admin Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4f46e5;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            background: #f8fafc;
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .auth-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Logs specific styles */
        .logs-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .logs-filters input, .logs-filters select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .logs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .logs-table th,
        .logs-table td {
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        
        .logs-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .logs-table tr.suspicious {
            background-color: #fef2f2;
        }
        
        .logs-table tr.error {
            background-color: #fffbeb;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .suspicious-badge {
            background-color: #dc2626;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button.active {
            background: #4f46e5;
            color: white;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .prompt-cell {
            max-width: 300px;
            word-break: break-word;
            font-family: monospace;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-flag {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .btn-unflag {
            background: #16a34a;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .tables-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .tables-row {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 15px 0;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .big-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4f46e5;
            margin: 10px 0;
        }
        
        .growth-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .growth-item {
            text-align: center;
            padding: 15px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #f9fafb;
        }
        
        .growth-number {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 5px;
        }
        
        .growth-label {
            display: block;
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .data-table th {
            background-color: #f9fafb;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            font-size: 0.85rem;
            color: #374151;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .email-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calls-cell {
            text-align: center;
            font-weight: bold;
            color: #4f46e5;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tier-free { 
            background: #fee2e2; 
            color: #991b1b; 
        }
        
        .tier-unlimited { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .tier-unlimitedmonthly { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .tier-starter { 
            background: #dcfce7; 
            color: #166534; 
        }
        
        .tier-pro { 
            background: #fef3c7; 
            color: #92400e; 
        }
        
        .tier-business { 
            background: #e0e7ff; 
            color: #3730a3; 
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-active { 
            background: #dcfce7; 
            color: #166534; 
        }
        
        .status-free { 
            background: #f3f4f6; 
            color: #374151; 
        }
        
        .refresh-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            color: #6b7280;
            padding: 20px;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        input[type="password"] {
            width: 300px;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 0.95rem;
        }
        
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        button:hover {
            background: #4338ca;
        }
        
        .timestamp {
            color: #6b7280;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 20px;
        }
        
        .success-indicator {
            color: #10b981;
            background: #ecfdf5;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #a7f3d0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛡️ AutoLister AI Admin Dashboard</h1>
        
        <div id="authSection" class="auth-section">
            <h3>🔐 Admin Authentication</h3>
            <div style="margin-bottom: 15px;">
                <input type="password" id="adminSecret" placeholder="Enter admin secret">
                <button onclick="authenticate()">Access Dashboard</button>
            </div>
            <div style="margin-top: 10px;">
                <label style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; color: #6b7280;">
                    <input type="checkbox" id="rememberDevice" style="margin: 0;">
                    Remember this device (stores key securely in browser)
                </label>
            </div>
            <div id="authError" class="error-message hidden" style="margin-top: 10px;"></div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Admin Dashboard</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="refresh-btn" onclick="refreshCurrentTab()">🔄 Refresh Data</button>
                    <button onclick="logout()" class="btn-secondary">Logout</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('overview')">📊 Overview</button>
                <button class="tab-button" onclick="switchTab('logs')">🔍 API Logs</button>
            </div>
            
            <!-- Overview Tab Content -->
            <div id="overviewTab" class="tab-content active">
                <div id="errorMessage" class="error-message hidden"></div>
                <div id="loadingMessage" class="loading hidden">Loading stats...</div>
            
            <!-- Row 1: Key Metrics -->
            <div class="stats-row">
                <div class="stat-card">
                    <h3>📊 Today's Usage</h3>
                    <div class="big-number" id="todayRequests">-</div>
                    <div>Total API Requests</div>
                    <div style="margin-top: 10px;">
                        <strong>Estimated Cost:</strong> $<span id="todayCost">0.00</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>👥 User Growth</h3>
                    <div class="growth-stats">
                        <div class="growth-item">
                            <span class="growth-number" id="totalUsers">-</span>
                            <span class="growth-label">Total Users</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="newToday">-</span>
                            <span class="growth-label">New Today</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="newThisWeek">-</span>
                            <span class="growth-label">This Week</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="activePaid">-</span>
                            <span class="growth-label">Paid Users</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>💰 Revenue Overview</h3>
                    <div class="growth-stats">
                        <div class="growth-item">
                            <span class="growth-number" id="monthlyRevenue">-</span>
                            <span class="growth-label">Monthly Revenue</span>
                        </div>
                        <div class="growth-item">
                            <span class="growth-number" id="conversionRate">-</span>
                            <span class="growth-label">Conversion Rate</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: User Tables -->
            <div class="tables-row">
                <div class="stat-card">
                    <h3>🔥 Top Users (This Month)</h3>
                    <table class="data-table" id="topUsersTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th style="width: 80px;">Calls</th>
                                <th style="width: 120px;">Tier</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="stat-card">
                    <h3>📈 Recent Signups</h3>
                    <table class="data-table" id="recentSignupsTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th style="width: 80px;">Date</th>
                                <th style="width: 80px;">Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Row 3: Rate Limits -->
            <div class="stat-card">
                <h3>Today's Daily Usage</h3>
                <div id="rateLimitsContent">Loading...</div>
            </div>

            <div class="timestamp" id="lastUpdated"></div>
            </div> <!-- End Overview Tab -->
            
            <!-- API Logs Tab Content -->
            <div id="logsTab" class="tab-content">
                <!-- Summary Cards -->
                <div class="stats-row">
                    <div class="stat-card">
                        <h3>Total Requests</h3>
                        <div class="big-number" id="totalRequests">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Suspicious Activity</h3>
                        <div class="big-number" id="suspiciousRequests" style="color: #dc2626;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Error Requests</h3>
                        <div class="big-number" id="errorRequests" style="color: #d97706;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Requests</h3>
                        <div class="big-number" id="todayRequests">-</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="stat-card" style="margin-bottom: 20px;">
                    <div class="logs-filters">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="suspiciousOnly">
                            Suspicious Only
                        </label>
                        
                        <input type="text" id="userIdFilter" placeholder="User ID" style="width: 200px;">
                        
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        
                        <button onclick="loadLogs()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">🔍 Filter</button>
                        <button onclick="clearLogFilters()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Clear</button>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="stat-card">
                    <div id="logsLoading" class="loading hidden">Loading logs...</div>
                    <div id="logsError" class="error-message hidden"></div>
                    
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Prompt</th>
                                    <th>Generated</th>
                                    <th>Flags</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="logsPagination" style="margin-top: 20px;">
                    </div>
                </div>
            </div> <!-- End Logs Tab -->
        </div> <!-- End Dashboard Section -->
    </div>

    <script>
        let adminSecret = '';
        let currentLogsPage = 1;

        // Tab Management
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Mark button as active
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'overview') {
                loadStats();
            } else if (tabName === 'logs') {
                loadLogs();
            }
        }

        function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab-button.active').textContent;
            if (activeTab.includes('Overview')) {
                loadStats();
            } else if (activeTab.includes('Logs')) {
                loadLogs();
            }
        }

        // API Logs Functions
        async function loadLogs(page = 1) {
            if (!adminSecret) return;

            const loading = document.getElementById('logsLoading');
            const error = document.getElementById('logsError');
            const tbody = document.getElementById('logsTableBody');
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            currentLogsPage = page;

            try {
                // Build query parameters
                const params = new URLSearchParams({
                    action: 'view-logs',
                    page: page.toString(),
                    limit: '50'
                });

                if (document.getElementById('suspiciousOnly').checked) {
                    params.append('suspicious', 'true');
                }

                const userId = document.getElementById('userIdFilter').value;
                if (userId) {
                    params.append('user_id', userId);
                }

                const startDate = document.getElementById('startDate').value;
                if (startDate) {
                    params.append('start_date', startDate);
                }

                const endDate = document.getElementById('endDate').value;
                if (endDate) {
                    params.append('end_date', endDate);
                }

                const response = await fetch(`/api/admin/logs?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load logs');
                }

                const data = await response.json();
                
                // Update summary
                updateLogsSummary(data.summary);
                
                // Update table
                updateLogsTable(data.logs);
                
                // Update pagination
                updateLogsPagination(data.pagination);
                
            } catch (err) {
                error.textContent = 'Failed to load logs: ' + err.message;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function updateLogsSummary(summary) {
            document.getElementById('totalRequests').textContent = summary?.total_requests || 0;
            document.getElementById('suspiciousRequests').textContent = summary?.suspicious_requests || 0;
            document.getElementById('errorRequests').textContent = summary?.error_requests || 0;
            document.getElementById('todayRequests').textContent = summary?.today_requests || 0;
        }

        function updateLogsTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';

            logs.forEach(log => {
                const row = tbody.insertRow();
                
                // Apply row styling
                if (log.suspicious_activity) {
                    row.classList.add('suspicious');
                } else if (log.response_status >= 400) {
                    row.classList.add('error');
                }

                row.innerHTML = `
                    <td style="font-size: 12px;">${formatDate(log.created_at)}</td>
                    <td style="font-size: 11px;">
                        ${log.user_email || 'N/A'}<br>
                        <span style="color: #6b7280;">${log.user_id?.substring(0, 8)}...</span>
                    </td>
                    <td>
                        <span class="status-badge ${log.response_status >= 200 && log.response_status < 300 ? 'status-success' : 'status-error'}">
                            ${log.response_status}
                        </span>
                    </td>
                    <td>${log.image_urls ? JSON.parse(log.image_urls).length : 0}</td>
                    <td class="prompt-cell">${truncate(log.raw_prompt, 150)}</td>
                    <td style="font-size: 11px; max-width: 150px;">${truncate(log.generated_title, 80)}</td>
                    <td>
                        ${log.suspicious_activity ? '<span class="suspicious-badge">🚨 SUSPICIOUS</span>' : ''}
                        ${log.flagged_reason ? `<br><small>${truncate(log.flagged_reason, 30)}</small>` : ''}
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${!log.suspicious_activity ? 
                                `<button class="btn-flag" onclick="flagLog('${log.id}', 'manual_review')">Flag</button>` :
                                `<button class="btn-unflag" onclick="unflagLog('${log.id}', 'reviewed_safe')">Unflag</button>`
                            }
                        </div>
                    </td>
                `;
            });
        }

        function updateLogsPagination(pagination) {
            const container = document.getElementById('logsPagination');
            container.innerHTML = '';

            if (pagination.total_pages <= 1) return;

            // Previous button
            if (pagination.page > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '← Previous';
                prevBtn.onclick = () => loadLogs(pagination.page - 1);
                prevBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;';
                container.appendChild(prevBtn);
            }

            // Page numbers (show current and nearby)
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadLogs(i);
                if (i === pagination.page) {
                    pageBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: #4f46e5; color: white; border: 1px solid #4f46e5; border-radius: 4px; cursor: pointer;';
                } else {
                    pageBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;';
                }
                container.appendChild(pageBtn);
            }

            // Next button
            if (pagination.page < pagination.total_pages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next →';
                nextBtn.onclick = () => loadLogs(pagination.page + 1);
                nextBtn.style.cssText = 'padding: 6px 12px; margin: 0 2px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;';
                container.appendChild(nextBtn);
            }
        }

        async function flagLog(logId, reason) {
            try {
                const response = await fetch('/api/admin/logs?action=flag-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminSecret}`
                    },
                    body: JSON.stringify({
                        logId,
                        reason,
                        action: 'flag'
                    })
                });

                if (response.ok) {
                    loadLogs(currentLogsPage); // Refresh current page
                } else {
                    alert('Failed to flag log');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function unflagLog(logId, reason) {
            try {
                const response = await fetch('/api/admin/logs?action=flag-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminSecret}`
                    },
                    body: JSON.stringify({
                        logId,
                        reason,
                        action: 'unflag'
                    })
                });

                if (response.ok) {
                    loadLogs(currentLogsPage); // Refresh current page
                } else {
                    alert('Failed to unflag log');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function clearLogFilters() {
            document.getElementById('suspiciousOnly').checked = false;
            document.getElementById('userIdFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            currentLogsPage = 1;
            loadLogs();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function truncate(text, maxLength) {
            if (!text) return 'N/A';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Security: Simple encryption for localStorage (basic obfuscation)
        function encryptKey(key) {
            return btoa(key.split('').reverse().join(''));
        }

        function decryptKey(encrypted) {
            try {
                return atob(encrypted).split('').reverse().join('');
            } catch (e) {
                return null;
            }
        }

        // Check for remembered key on page load
        function checkRememberedAuth() {
            const rememberedKey = localStorage.getItem('admin_auth_key');
            if (rememberedKey) {
                const decrypted = decryptKey(rememberedKey);
                if (decrypted) {
                    console.log('Found remembered auth key, attempting auto-login...');
                    adminSecret = decrypted;
                    document.getElementById('adminSecret').value = decrypted;
                    document.getElementById('rememberDevice').checked = true;
                    
                    // Try to authenticate with remembered key
                    testAuthAndLogin();
                }
            }
        }

        // Test authentication without showing UI changes
        async function testAuthAndLogin() {
            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (response.ok) {
                    // Success - show dashboard
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadStats();
                } else {
                    // Failed - clear remembered key and show auth form
                    localStorage.removeItem('admin_auth_key');
                    showAuthError('Stored authentication expired. Please re-enter your admin key.');
                }
            } catch (error) {
                // Network error - show auth form but keep remembered key
                console.log('Network error during auto-auth, showing login form');
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideAuthError() {
            document.getElementById('authError').classList.add('hidden');
        }

        function authenticate() {
            const inputSecret = document.getElementById('adminSecret').value.trim();
            const rememberDevice = document.getElementById('rememberDevice').checked;
            
            if (!inputSecret) {
                showAuthError('Please enter admin secret');
                return;
            }

            hideAuthError();
            adminSecret = inputSecret;
            
            // Test the key by making an API call
            testAuthentication(rememberDevice);
        }

        async function testAuthentication(shouldRemember) {
            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (response.ok) {
                    // Success - save key if requested
                    if (shouldRemember) {
                        const encrypted = encryptKey(adminSecret);
                        localStorage.setItem('admin_auth_key', encrypted);
                        console.log('Admin key saved for future sessions');
                    } else {
                        // Clear any previously saved key if user unchecked remember
                        localStorage.removeItem('admin_auth_key');
                    }
                    
                    // Show dashboard
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadStats();
                } else {
                    showAuthError('Invalid admin secret. Please try again.');
                }
            } catch (error) {
                showAuthError('Network error. Please check your connection and try again.');
            }
        }

        // Add logout functionality
        function logout() {
            // Clear session
            adminSecret = '';
            
            // Clear remembered key
            localStorage.removeItem('admin_auth_key');
            
            // Reset form
            document.getElementById('adminSecret').value = '';
            document.getElementById('rememberDevice').checked = false;
            hideAuthError();
            
            // Show auth section
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }

        async function loadStats() {
            const errorDiv = document.getElementById('errorMessage');
            const loadingDiv = document.getElementById('loadingMessage');
            
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminSecret}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayStats(data);
                
            } catch (error) {
                console.error('Error loading stats:', error);
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        function displayStats(data) {
            // Filter out demo account
            const filteredUsers = data.topUsers.filter(user => user.email !== 'samicodesit@gmail.com');
            
            // Create user lookup map for rate limiting section
            const userLookup = {};
            data.topUsers.forEach(user => {
                userLookup[user.id] = user.email;
            });
            
            // Today's stats
            document.getElementById('todayRequests').textContent = data.today.totalRequests;
            document.getElementById('todayCost').textContent = data.today.estimatedCost.toFixed(2);

            // User growth stats (excluding demo account)
            const totalUsers = filteredUsers.length;
            const paidUsers = filteredUsers.filter(u => u.subscription_status === 'active').length;
            const conversionRate = totalUsers > 0 ? ((paidUsers / totalUsers) * 100).toFixed(1) + '%' : '0%';
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activePaid').textContent = paidUsers;
            document.getElementById('conversionRate').textContent = conversionRate;
            
            // Calculate estimated monthly revenue
            const monthlyRevenue = paidUsers * 3.99;
            document.getElementById('monthlyRevenue').textContent = '€' + monthlyRevenue.toFixed(0);

            // Sort users by creation date for recent signups (most recent first)
            const sortedUsersByDate = [...filteredUsers].sort((a, b) => {
                const dateA = new Date(a.created_at || '2020-01-01');
                const dateB = new Date(b.created_at || '2020-01-01');
                return dateB - dateA; // Most recent first
            });
            
            // Calculate new users today and this week with proper timezone handling
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            let newToday = 0;
            let newThisWeek = 0;
            
            sortedUsersByDate.forEach(user => {
                if (!user.created_at) return;
                
                const userDate = new Date(user.created_at);
                const userDateOnly = new Date(userDate.getFullYear(), userDate.getMonth(), userDate.getDate());
                
                if (userDateOnly.getTime() === today.getTime()) {
                    newToday++;
                }
                if (userDateOnly >= weekAgo) {
                    newThisWeek++;
                }
            });
            
            document.getElementById('newToday').textContent = newToday;
            document.getElementById('newThisWeek').textContent = newThisWeek;

            // Top users table by API calls (exclude demo account)
            const topUsersByUsage = [...filteredUsers].sort((a, b) => b.api_calls_this_month - a.api_calls_this_month);
            const tbody = document.querySelector('#topUsersTable tbody');
            tbody.innerHTML = '';
            
            topUsersByUsage.slice(0, 10).forEach(user => {
                const row = tbody.insertRow();
                const tierClass = user.subscription_tier.replace(/_/g, '').toLowerCase();
                row.innerHTML = `
                    <td class="email-cell" title="${user.email}">${user.email}</td>
                    <td class="calls-cell">${user.api_calls_this_month}</td>
                    <td><span class="tier-badge tier-${tierClass}">${user.subscription_tier.replace('_', ' ')}</span></td>
                `;
            });

            // Recent signups table (sorted by creation date, most recent first)
            const signupsBody = document.querySelector('#recentSignupsTable tbody');
            signupsBody.innerHTML = '';
            
            sortedUsersByDate.slice(0, 15).forEach(user => { // Show more recent signups
                const row = signupsBody.insertRow();
                
                let dateStr = 'Unknown';
                if (user.created_at) {
                    const userDate = new Date(user.created_at);
                    const now = new Date();
                    const diffMs = now - userDate;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        dateStr = 'Today';
                    } else if (diffDays === 1) {
                        dateStr = 'Yesterday';
                    } else if (diffDays < 7) {
                        dateStr = `${diffDays}d ago`;
                    } else {
                        dateStr = userDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                }
                
                const statusClass = user.subscription_status === 'active' ? 'status-active' : 'status-free';
                const statusText = user.subscription_status === 'active' ? 'Paid' : 'Free';
                
                row.innerHTML = `
                    <td class="email-cell" title="${user.email}">${user.email}</td>
                    <td style="text-align: center;">${dateStr}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
            });

            // Rate limits
            const rateLimitsDiv = document.getElementById('rateLimitsContent');
            if (data.activeRateLimits.length === 0) {
                rateLimitsDiv.innerHTML = '<div class="success-indicator">✅ No daily usage recorded yet today</div>';
            } else {
                let html = '<table class="data-table"><thead><tr><th>User</th><th>Tier</th><th>Usage</th><th>Status</th><th>Expires</th></tr></thead><tbody>';
                data.activeRateLimits.forEach(limit => {
                    const expiry = new Date(limit.expires_at).toLocaleString();
                    const userEmail = limit.email || 'Unknown';
                    const userIdShort = limit.user_id.substring(0, 8) + '...';
                    const statusHtml = limit.is_blocked 
                        ? `<span style="color: #dc2626; font-weight: 600;">Blocked</span>`
                        : `<span style="color: #059669;">OK</span>`;
                    
                    html += `<tr>
                        <td>
                            <div style="font-weight: 500;">${userEmail}</div>
                            <div style="font-size: 0.75rem; color: #6b7280; font-family: monospace;">${userIdShort}</div>
                        </td>
                        <td><span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.875rem; text-transform: capitalize;">${limit.tier}</span></td>
                        <td><strong>${limit.count}</strong> / ${limit.daily_limit}</td>
                        <td>${statusHtml}</td>
                        <td>${expiry}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                rateLimitsDiv.innerHTML = html;
            }

            // Timestamp
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
        }

                // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkRememberedAuth();
        });

        // Auto-refresh every 30 seconds if dashboard is visible
        setInterval(() => {
            if (!document.getElementById('dashboardSection').classList.contains('hidden')) {
                loadStats();
            }
        }, 5 * 60 * 1000);

        // Allow Enter key to authenticate
        document.getElementById('adminSecret').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticate();
            }
        });
    </script>
</body>
</html>