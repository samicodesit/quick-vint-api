<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AutoLister AI - Pricing & Plans</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 40px;
            text-align: center;
            color: #333;
            background-color: #f9fafb;
        }

        h1 {
            font-size: 2.5rem;
            color: #4f46e5;
            margin-bottom: 0.5em;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #6b7280;
            margin-bottom: 3rem;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 2rem auto;
        }

        .pricing-card {
            background: white;
            border-radius: 16px;
            padding: 2.5rem 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .pricing-card.popular {
            border-color: #4f46e5;
            transform: scale(1.05);
        }

        .popular-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #4f46e5;
            color: white;
            padding: 8px 24px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .plan-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .plan-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .plan-price {
            font-size: 3rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }

        .plan-price .period {
            font-size: 1rem;
            color: #6b7280;
            font-weight: normal;
        }

        .features-list {
            text-align: left;
            margin: 2rem 0;
            padding: 0;
            list-style: none;
        }

        .features-list li {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .features-list li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .limits-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            text-align: left;
        }

        .limits-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .limits-list {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
            padding-left: 1rem;
        }

        .cta-button {
            width: 100%;
            padding: 1rem 2rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .cta-button:hover {
            background: #4338ca;
        }

        .cta-button.secondary {
            background: #6b7280;
        }

        .cta-button.secondary:hover {
            background: #374151;
        }

        .cta-button.current-plan {
            background: #10b981;
            cursor: default;
        }

        .cta-button.current-plan:hover {
            background: #10b981;
        }

        /* New button states */
        .cta-button.download-extension {
            background: #059669;
        }

        .cta-button.download-extension:hover {
            background: #047857;
        }

        .cta-button.sign-in {
            background: #7c3aed;
        }

        .cta-button.sign-in:hover {
            background: #6d28d9;
        }

        .cta-button.disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .cta-button.disabled:hover {
            background: #9ca3af;
        }

        .btn-text {
            flex: 1;
        }

        .btn-status {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .pricing-card.current {
            border-color: #10b981;
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
        }

        .pricing-card.current .plan-name::after {
            content: " ✓";
            color: #10b981;
            font-weight: bold;
        }

        footer {
            margin-top: 3rem;
            font-size: 0.9rem;
            color: #666;
        }

        .login-section {
            max-width: 500px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
        }

        .login-form {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .login-form input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
        }

        .login-form input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .login-form button {
            padding: 0.75rem 1.5rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .login-form button:hover {
            background: #4338ca;
        }

        .login-form button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .message.info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Choose Your Plan</h1>
    <p class="subtitle">Pricing designed for real sellers - from hobby to business</p>

    <div class="pricing-grid">
        <!-- Free Trial -->
        <div class="pricing-card">
            <div class="plan-name">Free Trial</div>
            <div class="plan-description">Get a taste of AutoLister AI</div>
            <div class="plan-price">€0<span class="period">/forever</span></div>
            
            <div class="limits-section">
                <div class="limits-title">Usage Limits</div>
                <ul class="limits-list">
                    <li>2 listings per day</li>
                    <li>10 listings total</li>
                    <li>Try before you buy</li>
                </ul>
            </div>

            <ul class="features-list">
                <li>AI-generated titles and descriptions</li>
                <li>Basic support</li>
                <li>See if you like it first</li>
            </ul>

            <button class="cta-button secondary" data-plan="free" id="btn-free">
                <span class="btn-text">Try Free</span>
                <span class="btn-status"></span>
            </button>
        </div>

        <!-- Starter -->
        <div class="pricing-card popular">
            <div class="popular-badge">Most Popular</div>
            <div class="plan-name">Starter</div>
            <div class="plan-description">Perfect for casual Vinted sellers</div>
            <div class="plan-price">€3.99<span class="period">/month</span></div>
            
            <div class="limits-section">
                <div class="limits-title">Usage Limits</div>
                <ul class="limits-list">
                    <li>15 listings per day</li>
                    <li>300 listings per month</li>
                    <li>10 per minute (quick retries)</li>
                    <!-- hourly limit removed -->
                </ul>
            </div>

            <ul class="features-list">
                <li>AI-generated titles and descriptions</li>
                <li>Priority support</li>
                <li>Perfect for weekend listing sessions</li>
            </ul>

            <button class="cta-button" data-plan="starter" id="btn-starter">
                <span class="btn-text">Get Starter Plan</span>
                <span class="btn-status"></span>
            </button>
        </div>

        <!-- Pro -->
        <div class="pricing-card">
            <div class="plan-name">Pro</div>
            <div class="plan-description">For active sellers listing daily</div>
            <div class="plan-price">€9.99<span class="period">/month</span></div>
            
            <div class="limits-section">
                <div class="limits-title">Usage Limits</div>
                <ul class="limits-list">
                    <li>40 listings per day</li>
                    <li>800 listings per month</li>
                    <li>20 per minute (quick retries)</li>
                    <!-- hourly limit removed -->
                </ul>
            </div>

            <ul class="features-list">
                <li>Everything in Starter</li>
                <li>Higher daily limits</li>
                <li>Priority processing</li>
            </ul>

            <button class="cta-button" data-plan="pro" id="btn-pro">
                <span class="btn-text">Get Pro Plan</span>
                <span class="btn-status"></span>
            </button>
        </div>

        <!-- Business -->
        <div class="pricing-card">
            <div class="plan-name">Business</div>
            <div class="plan-description">For resellers and high-volume sellers</div>
            <div class="plan-price">€19.99<span class="period">/month</span></div>
            
            <div class="limits-section">
                <div class="limits-title">Usage Limits</div>
                <ul class="limits-list">
                    <li>75 listings per day</li>
                    <li>1,500 listings per month</li>
                    <li>30 per minute (quick retries)</li>
                    <!-- hourly limit removed -->
                </ul>
            </div>

            <ul class="features-list">
                <li>Everything in Pro</li>
                <li>Highest daily limits</li>
                <li>Dedicated support</li>
                <li>Priority processing</li>
            </ul>

            <button class="cta-button" data-plan="business" id="btn-business">
                <span class="btn-text">Get Business Plan</span>
                <span class="btn-status"></span>
            </button>
        </div>
    </div>

    <footer>
        <p><strong>Why so limited for free?</strong> Free trial gives you just enough to see the magic ✨. Most sellers need more than 2 listings/day, making paid plans excellent value.</p>
        <p><strong>No surprises:</strong> All prices in EUR. Cancel anytime. No setup fees.</p>
        <p>&copy; 2025 AutoLister AI · All rights reserved · <a href="/privacy.html">Privacy Policy</a> · <a href="/terms.html">Terms of Service</a></p>
    </footer>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase with correct URL from extension
        const SUPABASE_URL = 'https://jqloiovdwjaornnfvmyu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxbG9pb3Zkd2phb3JubmZ2bXl1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODIwODMzMiwiZXhwIjoyMDYzNzg0MzMyfQ.Urz77RMqsJs8gJmA3yia_HhxaaeDrHURrF-fPeExRNQ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // API Base URL
        const API_BASE = "https://quick-vint.vercel.app";

        // Current user state
        let currentUser = null;
        let currentProfile = null;
        let hasExtension = false;

        // Plan configuration
        const PLAN_CONFIG = {
            free: { name: 'Free', price: 0 },
            unlimited_monthly: { name: 'Starter', price: 3.99 }, // Legacy support
            starter: { name: 'Starter', price: 3.99 },
            pro: { name: 'Pro', price: 9.99 },
            business: { name: 'Business', price: 19.99 }
        };

        // Check if extension is installed
        async function checkExtensionInstalled() {
            return new Promise((resolve) => {
                // Try to communicate with extension
                if (window.chrome && chrome.runtime) {
                    try {
                        chrome.runtime.sendMessage('mommklhpammnlojjobejddmidmdcalcl', { type: 'PING' }, (response) => {
                            resolve(!!response);
                        });
                    } catch (e) {
                        resolve(false);
                    }
                } else {
                    resolve(false);
                }
                // Timeout after 1 second
                setTimeout(() => resolve(false), 1000);
            });
        }

        // Get user data from extension
        async function getUserFromExtension() {
            return new Promise((resolve) => {
                if (!hasExtension) {
                    resolve(null);
                    return;
                }
                
                try {
                    chrome.runtime.sendMessage('mommklhpammnlojjobejddmidmdcalcl', { type: 'GET_USER_PROFILE' }, (response) => {
                        resolve(response);
                    });
                } catch (e) {
                    resolve(null);
                }
                // Timeout after 2 seconds
                setTimeout(() => resolve(null), 2000);
            });
        }

        // Utility functions for token handling
        function decodeUserData(token) {
            try {
                const jsonString = atob(token);
                const data = JSON.parse(jsonString);
                
                // Validate token freshness (within 10 minutes)
                if (data.timestamp && Date.now() - data.timestamp > 10 * 60 * 1000) {
                    console.warn('Token expired');
                    return null;
                }
                
                // Validate required fields
                if (data.source !== 'extension') {
                    console.warn('Invalid token source');
                    return null;
                }
                
                return data;
            } catch (e) {
                console.error('Failed to decode token:', e);
                return null;
            }
        }

        // Update button states based on user context
        function updateButtonStates() {
            const buttons = {
                free: document.getElementById('btn-free'),
                starter: document.getElementById('btn-starter'),
                pro: document.getElementById('btn-pro'),
                business: document.getElementById('btn-business')
            };

            const currentTier = currentProfile?.subscription_tier || 'free';
            const isActive = currentProfile?.subscription_status === 'active';

            Object.entries(buttons).forEach(([plan, button]) => {
                if (!button) return;

                const textSpan = button.querySelector('.btn-text');
                const statusSpan = button.querySelector('.btn-status');
                
                // Reset classes
                button.className = 'cta-button';
                
                if (plan === 'free') {
                    button.classList.add('secondary');
                }

                if (!hasExtension) {
                    // No extension installed
                    textSpan.textContent = 'Download Extension';
                    statusSpan.textContent = '';
                    button.classList.add('download-extension');
                } else if (!currentUser) {
                    // Extension installed, not signed in
                    if (plan === 'free') {
                        textSpan.textContent = 'Sign In to Start';
                        statusSpan.textContent = '';
                        button.classList.add('sign-in');
                    } else {
                        textSpan.textContent = 'Sign In to Subscribe';
                        statusSpan.textContent = '';
                        button.classList.add('sign-in');
                    }
                } else if (isActive && (currentTier === plan || (currentTier === 'unlimited_monthly' && plan === 'starter'))) {
                    // Current plan
                    textSpan.textContent = 'Current Plan';
                    statusSpan.textContent = '✓ Active';
                    button.classList.add('current-plan');
                } else {
                    // Signed in, different plan or free user
                    if (plan === 'free' && currentTier !== 'free') {
                        textSpan.textContent = 'Downgrade';
                        statusSpan.textContent = '';
                        button.classList.add('disabled');
                    } else if (plan === 'free') {
                        textSpan.textContent = 'Current Plan';
                        statusSpan.textContent = '✓ Active';
                        button.classList.add('current-plan');
                    } else {
                        const planConfig = PLAN_CONFIG[plan];
                        const currentPlanConfig = PLAN_CONFIG[currentTier];
                        
                        if (planConfig.price > currentPlanConfig.price) {
                            textSpan.textContent = `Upgrade to ${planConfig.name}`;
                        } else {
                            textSpan.textContent = `Switch to ${planConfig.name}`;
                        }
                        statusSpan.textContent = '';
                    }
                }
            });
        }

        // Handle button clicks
        async function handlePlanClick(planName) {
            const button = document.getElementById(`btn-${planName}`);
            const textSpan = button.querySelector('.btn-text');
            const originalText = textSpan.textContent;
            
            // Show loading state
            button.disabled = true;
            textSpan.textContent = 'Loading...';
            
            try {
                if (!hasExtension) {
                    // Download extension
                    downloadExtension();
                    return;
                }

                if (!currentUser) {
                    // Prompt to sign in through extension
                    alert('Please sign in through the AutoLister AI extension first, then return to this page.');
                    return;
                }

                if (planName === 'free') {
                    // Already on free or trying to downgrade
                    if (currentProfile?.subscription_tier === 'free') {
                        alert('You are already on the free plan!');
                        return;
                    } else {
                        // Redirect to customer portal to cancel
                        await openCustomerPortal();
                        return;
                    }
                }

                // Handle paid plan selection
                const currentTier = currentProfile?.subscription_tier || 'free';
                const isActive = currentProfile?.subscription_status === 'active';

                if (isActive && (currentTier === planName || (currentTier === 'unlimited_monthly' && planName === 'starter'))) {
                    // Already on this plan - open customer portal
                    await openCustomerPortal();
                } else {
                    // Upgrade/switch plan
                    await handlePaidPlanSelection(planName);
                }
            } catch (error) {
                console.error('Plan selection error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                // Reset button state
                button.disabled = false;
                textSpan.textContent = originalText;
            }
        }

        // Handle paid plan selection (upgrade/switch)
        async function handlePaidPlanSelection(planName) {
            try {
                const response = await fetch(`${API_BASE}/api/stripe/create-checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUser.email,
                        tier: planName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.open(data.url, '_blank');
                } else {
                    console.error('Checkout error:', data);
                    alert(`Unable to start checkout: ${data.error || 'Please try again.'}`);
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Network error. Please check your connection and try again.');
            }
        }

        // Open customer portal for existing subscribers
        async function openCustomerPortal() {
            try {
                const response = await fetch(`${API_BASE}/api/stripe/create-portal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: currentUser.email })
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.open(data.url, '_blank');
                } else {
                    console.error('Portal error:', data);
                    alert(`Unable to open customer portal: ${data.error || 'Please try again.'}`);
                }
            } catch (error) {
                console.error('Portal error:', error);
                alert('Network error. Please check your connection and try again.');
            }
        }

        // Download extension
        function downloadExtension() {
            window.open('https://chromewebstore.google.com/detail/autolister-ai/mommklhpammnlojjobejddmidmdcalcl', '_blank');
        }

        // Initialize page
        async function initializePage() {
            // Check URL parameters first (they have priority if coming from extension)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                // New token-based approach
                const userData = decodeUserData(token);
                if (userData && userData.source === 'extension') {
                    hasExtension = true;
                    
                    if (userData.signed_in && userData.email) {
                        // Create user object from decoded token
                        currentUser = { email: userData.email };
                        currentProfile = {
                            subscription_tier: userData.plan,
                            subscription_status: (userData.plan !== 'free') ? 'active' : 'free'
                        };
                    }
                    
                    console.log('Initialized from extension token:', {
                        hasExtension,
                        userPlan: userData.plan,
                        isSignedIn: userData.signed_in
                    });
                } else {
                    console.warn('Invalid or expired token, falling back to extension detection');
                    // Fall through to extension detection
                }
            } else {
                // Legacy approach - check old-style URL parameters
                const isFromExtension = urlParams.get('source') === 'extension';
                
                if (isFromExtension) {
                    // Use URL parameters when coming from extension (legacy support)
                    hasExtension = true;
                    const isSignedIn = urlParams.get('signed_in') === 'true';
                    const userPlan = urlParams.get('plan') || 'free';
                    const userEmail = urlParams.get('email') || '';
                    
                    if (isSignedIn && userEmail) {
                        // Create user object from URL params
                        currentUser = { email: userEmail };
                        currentProfile = {
                            subscription_tier: userPlan,
                            subscription_status: (userPlan !== 'free') ? 'active' : 'free'
                        };
                    }
                    
                    console.log('Initialized from extension URL params (legacy):', {
                        hasExtension,
                        isSignedIn,
                        userPlan,
                        userEmail
                    });
                }
            }
            
            // If no extension context found, fallback to extension detection for direct visits
            if (!hasExtension) {
                hasExtension = await checkExtensionInstalled();
                
                if (hasExtension) {
                    // Get user data from extension
                    const userData = await getUserFromExtension();
                    if (userData) {
                        currentUser = userData.user;
                        currentProfile = userData.profile;
                    }
                }
            }

            // Update button states
            updateButtonStates();

            // Add event listeners
            document.getElementById('btn-free').addEventListener('click', () => handlePlanClick('free'));
            document.getElementById('btn-starter').addEventListener('click', () => handlePlanClick('starter'));
            document.getElementById('btn-pro').addEventListener('click', () => handlePlanClick('pro'));
            document.getElementById('btn-business').addEventListener('click', () => handlePlanClick('business'));
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializePage);

        // Refresh user data when page gains focus (in case user signed in through extension)
        window.addEventListener('focus', async () => {
            if (hasExtension) {
                const userData = await getUserFromExtension();
                if (userData) {
                    const userChanged = currentUser?.id !== userData.user?.id;
                    const profileChanged = JSON.stringify(currentProfile) !== JSON.stringify(userData.profile);
                    
                    if (userChanged || profileChanged) {
                        currentUser = userData.user;
                        currentProfile = userData.profile;
                        updateButtonStates();
                    }
                }
            }
        });
    </script>
</body>

</html>