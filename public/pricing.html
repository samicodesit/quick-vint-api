<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F2QL50WB6M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-F2QL50WB6M');
    </script>

    <title>AutoLister AI - Pricing & Plans</title>
    <!-- Link to the external stylesheet for consistent header/nav/page styling -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- MOBILE MENU STRUCTURE (Matching index.html) -->
    <div id="menu-backdrop" class="menu-backdrop" aria-hidden="true"></div>

    <div id="mobile-menu" class="mobile-menu">
        <button id="sheet-close" class="sheet-close" aria-label="Close menu">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <a href="index.html#features">Features</a>
        <a href="#pricing">Pricing</a>
        <a href="mailto:hello@autolister.app">Contact</a>
        <a href="https://chromewebstore.google.com/detail/autolister-ai/mommklhpammnlojjobejddmidmdcalcl"
            target="_blank">Get Extension</a>
    </div>

    <!-- SHARED HEADER -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="logo">AutoLister AI</a>
                <div class="nav-links">
                    <a href="index.html#features">Features</a>
                    <a href="#pricing">Pricing</a>
                    <a href="mailto:hello@autolister.app">Contact</a>
                    <a href="https://chromewebstore.google.com/detail/autolister-ai/mommklhpammnlojjobejddmidmdcalcl"
                        target="_blank" class="btn-nav">Get Extension</a>
                </div>
                <div class="mobile-menu-button">
                    <button id="hamburger-button" class="hamburger" aria-expanded="false" aria-controls="mobile-menu"
                        aria-label="Open navigation menu">
                        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <g stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <line id="ham-top" x1="3" y1="6" x2="21" y2="6"></line>
                                <line id="ham-mid" x1="3" y1="12" x2="21" y2="12"></line>
                                <line id="ham-bot" x1="3" y1="18" x2="21" y2="18"></line>
                            </g>
                        </svg>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT WRAPPED FOR LAYOUT -->
    <!-- The .pricing-page-content class handles alignment and max-width for the entire page body content -->
    <div class="pricing-page-content">
        <h1 class="pricing-h1">Choose Your Plan</h1>
        <p class="subtitle">Pricing designed for real sellers - from hobby to business</p>

        <div class="pricing-grid">
            <!-- Free Trial -->
            <div class="pricing-card">
                <div class="plan-name">Free Trial</div>
                <div class="plan-description">Get a taste of AutoLister AI</div>
                <div class="plan-price">€0<span class="period">/forever</span></div>

                <div class="limits-section">
                    <div class="limits-title">Usage Limits</div>
                    <ul class="limits-list">
                        <li>Daily: 2 listings per day</li>
                        <li>Monthly: 10 listings per month</li>
                        <li>Try before you buy</li>
                    </ul>
                </div>

                <ul class="features-list">
                    <li>AI-generated titles and descriptions</li>
                    <li>Basic support</li>
                    <li>See if you like it first</li>
                </ul>

                <button class="cta-button secondary" data-plan="free" id="btn-free">
                    <span class="btn-text">Try Free</span>
                    <span class="btn-status"></span>
                </button>
            </div>

            <!-- Starter -->
            <div class="pricing-card popular">
                <div class="popular-badge">Most Popular</div>
                <div class="plan-name">Starter</div>
                <div class="plan-description">Perfect for casual Vinted sellers</div>
                <div class="plan-price">€3.99<span class="period">/month</span></div>

                <div class="limits-section">
                    <div class="limits-title">Usage Limits</div>
                    <ul class="limits-list">
                        <li>Daily: 15 listings per day</li>
                        <li>Monthly: 300 listings per month</li>
                    </ul>
                </div>

                <ul class="features-list">
                    <li>AI-generated titles and descriptions</li>
                    <li>Priority support</li>
                    <li>Perfect for weekend listing sessions</li>
                </ul>

                <button class="cta-button" data-plan="starter" id="btn-starter">
                    <span class="btn-text">Get Starter Plan</span>
                    <span class="btn-status"></span>
                </button>
            </div>

            <!-- Pro -->
            <div class="pricing-card">
                <div class="plan-name">Pro</div>
                <div class="plan-description">For active sellers listing daily</div>
                <div class="plan-price">€9.99<span class="period">/month</span></div>

                <div class="limits-section">
                    <div class="limits-title">Usage Limits</div>
                    <ul class="limits-list">
                        <li>Daily: 40 listings per day</li>
                        <li>Monthly: 800 listings per month</li>
                    </ul>
                </div>

                <ul class="features-list">
                    <li>Everything in Starter</li>
                    <li>Higher daily limits</li>
                    <li>Priority processing</li>
                </ul>

                <button class="cta-button" data-plan="pro" id="btn-pro">
                    <span class="btn-text">Get Pro Plan</span>
                    <span class="btn-status"></span>
                </button>
            </div>

            <!-- Business -->
            <div class="pricing-card">
                <div class="plan-name">Business</div>
                <div class="plan-description">For resellers and high-volume sellers</div>
                <div class="plan-price">€19.99<span class="period">/month</span></div>

                <div class="limits-section">
                    <div class="limits-title">Usage Limits</div>
                    <ul class="limits-list">
                        <li>Daily: N/A — Business plan has no daily limit</li>
                        <li>Monthly: 1,500 listings per month</li>
                    </ul>
                </div>

                <ul class="features-list">
                    <li>Everything in Pro</li>
                    <li>Highest daily limits</li>
                    <li>Dedicated support</li>
                    <li>Priority processing</li>
                </ul>

                <button class="cta-button" data-plan="business" id="btn-business">
                    <span class="btn-text">Get Business Plan</span>
                    <span class="btn-status"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- FOOTER: Using a dedicated class here since the index.html footer is dark and structured differently -->
    <footer class="footer-pricing-page">
        <p><strong>Why so limited for free?</strong> Free trial gives you just enough to see the magic ✨. Most sellers
            need more than 2 listings/day, making paid plans excellent value.</p>
        <p><strong>No surprises:</strong> All prices in EUR. Cancel anytime. No setup fees.</p>
        <p>&copy; 2025 AutoLister AI · All rights reserved · <a href="/privacy.html">Privacy Policy</a> · <a
                href="/terms.html">Terms of Service</a></p>
    </footer>

    <!-- Supabase SDK (Original Script) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // JavaScript for the mobile menu (class toggles + aria)
        const hamburgerButton = document.getElementById('hamburger-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const backdrop = document.getElementById('menu-backdrop');
        const sheetClose = document.getElementById('sheet-close');

        function setMenuOpen(open) {
            if (open) {
                hamburgerButton.classList.add('open');
                mobileMenu.classList.add('open');
                backdrop.classList.add('open');

                hamburgerButton.setAttribute('aria-expanded', 'true');
                hamburgerButton.setAttribute('aria-label', 'Close navigation menu');

                // focus close for accessibility
                if (sheetClose) sheetClose.focus();

                // dim the page behind the overlay for a polished look
                document.body.classList.add('menu-dim');
                document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
            } else {
                hamburgerButton.classList.remove('open');
                mobileMenu.classList.remove('open');
                backdrop.classList.remove('open');

                hamburgerButton.setAttribute('aria-expanded', 'false');
                hamburgerButton.setAttribute('aria-label', 'Open navigation menu');

                document.body.classList.remove('menu-dim');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        hamburgerButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = mobileMenu.classList.contains('open'); // Check menu state directly
            setMenuOpen(!isOpen);
        });

        // Close drawer when any menu link is clicked (good UX)
        document.querySelectorAll('#mobile-menu a').forEach((el) => {
            el.addEventListener('click', () => setMenuOpen(false));
        });

        // Sheet close button
        if (sheetClose) {
            sheetClose.addEventListener('click', () => setMenuOpen(false));
        }

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (mobileMenu.classList.contains('open')) {
                    setMenuOpen(false);
                }
            }
        });

        // FIX: Reliable Backdrop/Outside Click Handler
        backdrop.addEventListener('click', (e) => {
            // Because the backdrop is fixed, covers the screen, and has pointer-events: auto when open,
            // this is the most reliable way to handle outside clicks.
            setMenuOpen(false);
        });

        // Original Pricing Page Logic starts here
        // Initialize Supabase with correct URL from extension
        const SUPABASE_URL = 'https://jqloiovdwjaornnfvmyu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxbG9pb3Zkd2phb3JubmZ2bXl1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODIwODMzMiwiZXhwIjoyMDYzNzg0MzMyfQ.Urz77RMqsJs8gJmA3yia_HhxaaeDrHURrF-fPeExRNQ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // API Base URL
        const API_BASE = "https://quick-vint.vercel.app";

        // Current user state
        let currentUser = null;
        let currentProfile = null;
        let hasExtension = false;

        // Plan configuration
        const PLAN_CONFIG = {
            free: { name: 'Free', price: 0 },
            unlimited_monthly: { name: 'Starter', price: 3.99 }, // Legacy support
            starter: { name: 'Starter', price: 3.99 },
            pro: { name: 'Pro', price: 9.99 },
            business: { name: 'Business', price: 19.99 }
        };

        // Check if extension is installed
        async function checkExtensionInstalled() {
            return new Promise((resolve) => {
                // Try to communicate with extension
                if (window.chrome && chrome.runtime) {
                    try {
                        chrome.runtime.sendMessage('mommklhpammnlojjobejddmidmdcalcl', { type: 'PING' }, (response) => {
                            resolve(!!response);
                        });
                    } catch (e) {
                        resolve(false);
                    }
                } else {
                    resolve(false);
                }
                // Timeout after 1 second
                setTimeout(() => resolve(false), 1000);
            });
        }

        // Get user data from extension
        async function getUserFromExtension() {
            return new Promise((resolve) => {
                if (!hasExtension) {
                    resolve(null);
                    return;
                }

                try {
                    chrome.runtime.sendMessage('mommklhpammnlojjobejddmidmdcalcl', { type: 'GET_USER_PROFILE' }, (response) => {
                        resolve(response);
                    });
                } catch (e) {
                    resolve(null);
                }
                // Timeout after 2 seconds
                setTimeout(() => resolve(null), 2000);
            });
        }

        // Utility functions for token handling
        function decodeUserData(token) {
            try {
                const jsonString = atob(token);
                const data = JSON.parse(jsonString);

                // Validate token freshness (within 10 minutes)
                if (data.timestamp && Date.now() - data.timestamp > 10 * 60 * 1000) {
                    console.warn('Token expired');
                    return null;
                }

                // Validate required fields
                if (data.source !== 'extension') {
                    console.warn('Invalid token source');
                    return null;
                }

                return data;
            } catch (e) {
                console.error('Failed to decode token:', e);
                return null;
            }
        }

        // Update button states based on user context
        function updateButtonStates() {
            const buttons = {
                free: document.getElementById('btn-free'),
                starter: document.getElementById('btn-starter'),
                pro: document.getElementById('btn-pro'),
                business: document.getElementById('btn-business')
            };

            const currentTier = currentProfile?.subscription_tier || 'free';
            const isActive = currentProfile?.subscription_status === 'active';

            Object.entries(buttons).forEach(([plan, button]) => {
                if (!button) return;

                const textSpan = button.querySelector('.btn-text');
                const statusSpan = button.querySelector('.btn-status');

                // Reset classes
                button.className = 'cta-button';

                if (plan === 'free') {
                    button.classList.add('secondary');
                }

                if (!hasExtension) {
                    // No extension installed
                    textSpan.textContent = 'Download Extension';
                    statusSpan.textContent = '';
                    button.classList.add('download-extension');
                } else if (!currentUser) {
                    // Extension installed, not signed in
                    if (plan === 'free') {
                        textSpan.textContent = 'Sign In to Start';
                        statusSpan.textContent = '';
                        button.classList.add('sign-in');
                    } else {
                        textSpan.textContent = 'Sign In to Subscribe';
                        statusSpan.textContent = '';
                        button.classList.add('sign-in');
                    }
                } else if (isActive && (currentTier === plan || (currentTier === 'unlimited_monthly' && plan === 'starter'))) {
                    // Current plan
                    textSpan.textContent = 'Current Plan';
                    statusSpan.textContent = '✓ Active';
                    button.classList.add('current-plan');
                } else {
                    // Signed in, different plan or free user
                    if (plan === 'free' && currentTier !== 'free') {
                        textSpan.textContent = 'Downgrade';
                        statusSpan.textContent = '';
                        button.classList.add('disabled');
                    } else if (plan === 'free') {
                        textSpan.textContent = 'Current Plan';
                        button.classList.add('current-plan');
                    } else {
                        const planConfig = PLAN_CONFIG[plan];
                        const currentPlanConfig = PLAN_CONFIG[currentTier];

                        if (planConfig.price > currentPlanConfig.price) {
                            textSpan.textContent = `Upgrade to ${planConfig.name}`;
                        } else {
                            textSpan.textContent = `Switch to ${planConfig.name}`;
                        }
                        statusSpan.textContent = '';
                    }
                }
            });
        }

        // Handle button clicks
        async function handlePlanClick(planName) {
            const button = document.getElementById(`btn-${planName}`);
            const textSpan = button.querySelector('.btn-text');
            const originalText = textSpan.textContent;

            // Show loading state
            button.disabled = true;
            textSpan.textContent = 'Loading...';

            try {
                if (!hasExtension) {
                    // Download extension
                    downloadExtension();
                    return;
                }

                if (!currentUser) {
                    // Prompt to sign in through extension
                    // IMPORTANT: Using custom modal/message box instead of alert()
                    console.log('User not signed in. Please sign in through the AutoLister AI extension first, then return to this page.');
                    // In a real app, you would show a modal here.
                    return;
                }

                if (planName === 'free') {
                    // Already on free or trying to downgrade
                    if (currentProfile?.subscription_tier === 'free') {
                        console.log('You are already on the free plan!');
                        return;
                    } else {
                        // Redirect to customer portal to cancel
                        await openCustomerPortal();
                        return;
                    }
                }

                // Handle paid plan selection
                const currentTier = currentProfile?.subscription_tier || 'free';
                const isActive = currentProfile?.subscription_status === 'active';

                if (isActive && (currentTier === planName || (currentTier === 'unlimited_monthly' && planName === 'starter'))) {
                    // Already on this plan - open customer portal
                    await openCustomerPortal();
                } else {
                    // Upgrade/switch plan
                    await handlePaidPlanSelection(planName);
                }
            } catch (error) {
                console.error('Plan selection error:', error);
                // In a real app, you would show an error modal here.
            } finally {
                // Reset button state
                button.disabled = false;
                textSpan.textContent = originalText;
            }
        }

        // Handle paid plan selection (upgrade/switch)
        async function handlePaidPlanSelection(planName) {
            try {
                const response = await fetch(`${API_BASE}/api/stripe/create-checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUser.email,
                        tier: planName
                    })
                });

                const data = await response.json();

                if (response.ok && data.url) {
                    window.open(data.url, '_blank');
                } else {
                    console.error('Checkout error:', data);
                    // In a real app, you would show an error modal here.
                }
            } catch (error) {
                console.error('Checkout error:', error);
                // In a real app, you would show an error modal here.
            }
        }

        // Open customer portal for existing subscribers
        async function openCustomerPortal() {
            try {
                const response = await fetch(`${API_BASE}/api/stripe/create-portal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: currentUser.email })
                });

                const data = await response.json();

                if (response.ok && data.url) {
                    window.open(data.url, '_blank');
                } else {
                    console.error('Portal error:', data);
                    // In a real app, you would show an error modal here.
                }
            } catch (error) {
                console.error('Portal error:', error);
                // In a real app, you would show an error modal here.
            }
        }

        // Download extension
        function downloadExtension() {
            window.open('https://chromewebstore.google.com/detail/autolister-ai/mommklhpammnlojjobejddmidmdcalcl', '_blank');
        }

        // Initialize page
        async function initializePage() {
            // Check URL parameters first (they have priority if coming from extension)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (token) {
                // New token-based approach
                const userData = decodeUserData(token);
                if (userData && userData.source === 'extension') {
                    hasExtension = true;

                    if (userData.signed_in && userData.email) {
                        // Create user object from decoded token
                        currentUser = { email: userData.email };
                        currentProfile = {
                            subscription_tier: userData.plan,
                            subscription_status: (userData.plan !== 'free') ? 'active' : 'free'
                        };
                    }

                    console.log('Initialized from extension token:', {
                        hasExtension,
                        userPlan: userData.plan,
                        isSignedIn: userData.signed_in
                    });
                } else {
                    console.warn('Invalid or expired token, falling back to extension detection');
                    // Fall through to extension detection
                }
            } else {
                // Legacy approach - check old-style URL parameters
                const isFromExtension = urlParams.get('source') === 'extension';

                if (isFromExtension) {
                    // Use URL parameters when coming from extension (legacy support)
                    hasExtension = true;
                    const isSignedIn = urlParams.get('signed_in') === 'true';
                    const userPlan = urlParams.get('plan') || 'free';
                    const userEmail = urlParams.get('email') || '';

                    if (isSignedIn && userEmail) {
                        // Create user object from URL params
                        currentUser = { email: userEmail };
                        currentProfile = {
                            subscription_tier: userPlan,
                            subscription_status: (userPlan !== 'free') ? 'active' : 'free'
                        };
                    }

                    console.log('Initialized from extension URL params (legacy):', {
                        hasExtension,
                        isSignedIn,
                        userPlan,
                        userEmail
                    });
                }
            }

            // If no extension context found, fallback to extension detection for direct visits
            if (!hasExtension) {
                hasExtension = await checkExtensionInstalled();

                if (hasExtension) {
                    // Get user data from extension
                    const userData = await getUserFromExtension();
                    if (userData) {
                        currentUser = userData.user;
                        currentProfile = userData.profile;
                    }
                }
            }

            // Update button states
            updateButtonStates();

            // Add event listeners
            document.getElementById('btn-free').addEventListener('click', () => handlePlanClick('free'));
            document.getElementById('btn-starter').addEventListener('click', () => handlePlanClick('starter'));
            document.getElementById('btn-pro').addEventListener('click', () => handlePlanClick('pro'));
            document.getElementById('btn-business').addEventListener('click', () => handlePlanClick('business'));
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializePage);

        // Refresh user data when page gains focus (in case user signed in through extension)
        window.addEventListener('focus', async () => {
            if (hasExtension) {
                const userData = await getUserFromExtension();
                if (userData) {
                    const userChanged = currentUser?.id !== userData.user?.id;
                    const profileChanged = JSON.stringify(currentProfile) !== JSON.stringify(userData.profile);

                    if (userChanged || profileChanged) {
                        currentUser = userData.user;
                        currentProfile = userData.profile;
                        updateButtonStates();
                    }
                }
            }
        });
    </script>
</body>

</html>